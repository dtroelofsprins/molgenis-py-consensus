# VKGL Data release

This guide will explain every step in the VKGL Data release process. Please follow it step by step to guarantee
consistent output for every export.

## Prerequisites

- Install [Molgenis Commander](https://github.com/molgenis/molgenis-tools-commander)
- Paste [these files](https://github.com/molgenis/molgenis-py-consensus/tree/master/mcmd_scripts) in `.mcmd/scripts`
- Set `import_action` in the `settings` section of `mcmd.yaml` to `add`
- Add the `output` folder of `molgenis-py-consensus` to `dataset_folders` in  `mcmd.yaml`

## Step-by-step guide

1. Request a test server. It should be a copy of the current VKGL molgenis server.
2. Get the Alissa files and store them in some folder.
3. Get the LUMC and Radboud/MUMC files and store them in a separate folder.
4. Get the latest tag of [`data-transform-vkgl`](https://github.com/molgenis/data-transform-vkgl/tags)
   (every release, we create a new tag that uses the newest release in the helper scripts):

```commandline
wget https://github.com/molgenis/data-transform-vkgl/archive/refs/tags/data-release-v*insert versionnumber*.zip
unzip data-release-v*insert versionnumber*.zip
```

5. Go to the `data-release-pipeline` folder of the folder you just unzipped and make sure you have excecute permissions
   in the whole directory.
6. Adjust the filenames in `run.sh` to fit the filenames of this export (they are `vkgl_original_filename.tsv`). 
7. Run `run.sh` like this:

```
./run.sh -l /path/to/lumc.tsv -r /path/to/radboud_mumc.tsv --aws_credentials /path/to/aws/credentials --aws_config  /path/to/aws/config -s /path/to/folder/with/alissa/data
```

8. Create a screen. Then validate the output it generated by running the validation script:

```commandline
screen
ml PythonPlus
python validator/main.py /folder/created/by/run.sh/
```

9. If all checks are successful, continue, else rerun `run.sh` or pinpoint the issue.
10. Change directory back to Download the most recent version of the
   molgenis [EMX downloader](https://github.com/molgenis/molgenis-tools-emx-downloader):

```commandline
wget https://registry.molgenis.org/repository/maven-releases/org/molgenis/downloader/*insert version here*/downloader-*insert version here*.jar
unzip downloader-*insert newest version here*.zip
```

11. Download the current consensus and consensus comments:

```commandline
java -jar downloader-*insert version here*.jar -f consensus.zip -u https://yourserver/ -a admin vkgl_consensus
```

12. Unzip the downloaded zip

```commandline
unzip consensus.zip
```

13. Now you can either run [this script](https://github.com/molgenis/data-transform-vkgl/pull/50) the following way (
    assuming it's reviewed and merged):
    IMPORTANT: if you're reproducing, make sure you also specify `-m` with the version of `molgenis-py-consensus` that
    was used the last time.

```commandline
python -m venv env
python source env/bin/activate
pip install -e .
python main.py -v /folder/created/by/run.sh/ -l umcg,umcu,nki,amc,vumc,radboud_mumc,lumc,erasmus -i /place/to/store/input/for/molgenis-py-consensus -o /place/to/store/output/for/molgenis-py-consensus -p *comma separated list of yymm dates of all releases* -c unzipped/consensus/folder/vkgl_consensus.tsv -cc unzipped/consensus/folder/vkgl_consensus_comments.tsv
```

Or, do the steps manually:

- Download the latest version (or the one you need) of molgenis-py-consensus
- Create an input and output folder for this tool
- Create a `config.txt` in the `molgenis-py-consensus/config` directory. Example:

```text
labs=umcg,umcu,nki,amc,vumc,radboud_mumc,lumc,erasmus
prefix=vkgl_
consensus=consensus
comments=comments
previous=1805,1810,1906,1910,1912,2003,2006,2009,2101,2104,2106,2109
history=consensus_history
input=place/to/store/input/for/molgenis-py-consensus/
output=place/to/store/output/for/molgenis-py-consensus/
```

Make sure to update the `previous`, `input` and `output`. The other values will (almost) always stay the same.

- Copy the `vkgl_vkgl`-lab files and the `vkgl_` files of radboud and LUMC to the input dir you specified in the config.
- Grant permissions to run the consensus scripts:

```commandline
chmod g+x -R /path/to/molgenis-py-consensus
```

- Change dir to molgenis-py-consensus
- Setup and install molgenis-py-consensus

```commandline
python -m venv env
python source env/bin/activate
pip install -e .
```

- Run the preprocessor:

```commandline
python preprocessing/PreProcessor.py
```

- Run the history writer:

```commandline
python preprocessing/HistoryWriter.py
```

14. Make sure you first purge your pythonPlus before installing the commander:
    ```commandline
    module purge PythonPlus
    ```
    Then install the commander, following
    [this guide](https://github.com/molgenis/molgenis-tools-commander/wiki/Installation-guide). Add the production and
    test server as hosts to the commander using the `mcmd config add host` command.


15. Configure molgenis commander host to test server.

``` commandline
mcmd config set host
```

16. Import the consensus history on your testserver

```commandline
mcmd import vkgl_consensus_history.tsv
```

17. Check your molgenis server to make sure the history is uploaded. There should be variants from the previous export
    available in the table. If it looks okay, change the mcmd host to production and run the same command.
18. Go to the folder you want to store the history zip. Download the complete consensus history using the EMX
    downloader:

```commandline
java -jar downloader.jar -f consensus_history.zip -u https://yourserver/ -a admin vkgl_consensus_history
unzip consensus_history.zip
```

19. Place the vkgl_consensus_history.tsv from the zip in your `molgenis-py-consensus` input directory.
20. Load pythonplus again and install the consensus-script. Go to the directory of `molgenis-py-consensus`.

```commandline
ml PythonPlus
python -m venv env
pip install -e .
```

21. Make sure you still have a screen running (`screen -ls`). Then run the consensus script:

```commandline
python consensus
```

22. The script takes about 18 hours to run, so detach your screen to make sure your internet connection won't mess up
    the script run, by pressing `ctrl+a d`.

23. Now you have plenty of time to create the ClinVar files. To do this, get the most recent version (or another
    version, if you wish) of [vkgl-clinvar](https://github.com/molgenis/vkgl-clinvar).

```
wget https://github.com/molgenis/vkgl-clinvar/releases/download/vx.y.z/vkgl-clinvar-writer.jar
```

24. Go to clinvar, select `Submit` in the dropdown and click `Submission portal` (this way you will be redirected to the
    correct overview). Download `SUB*submission id*_(100)_submitter_report_B.txt` of the previous ClinVar submits for
    all labs.

25. Create an output folder for your clinvar submit files and put the pseudogenes file in there, which can be downloaded
 here:
26. Run the script:

``` commandline
java -jar vkgl-clinvar-writer.jar -i /path/to/consensus.tsv -m /path/to/mmmm_2021_UNCHANGED_identifiers.tsv -c amc=/path/to/SUB*nr*_(100)_submitter_report_B.txt,lumc=/path/to/lumc_SUB*nr*_(100)_submitter_report_B.txt,nki=/path/to/nki_SUB*nr*_(100)_submitter_report_B.txt,umcg=/path/to/umcg_SUB*nr*_(100)_submitter_report_B.txt,radboud_mumc=/path/to/radboud_SUB*nr*_(100)_submitter_report_B.txt,umc_utrecht=/path/to/umcu_SUB*nr*_(100)_submitter_report_B.txt,vumc=/path/to/vumc_SUB*nr*_(100)_submitter_report_B.txt,erasmus_mc=/path/to/erasmus_SUB*nr*_(100)_submitter_report_B.txt -o /path/to/output/dir -pg /path/to/pseudogenes/file -r mmm_yyyy -dl path/to/sept_2021_REMOVED_identifiers_MANUALFIX.tsv
```
! DON'T SUBMIT THE CLINVAR FILES UNTIL THEY ARE ACCEPTED !

27. Check if your consensus script is still running:

```commandline
screen -r
```

If everything is okay, press `ctrl+a d` again. Now all we need to do is wait until the script is done. After it'ss done,
type `deactivate` to deactivate the virtual environment.

28. Make sure you purge the PythonPlus module again and load Python to run the commander.

29. Change the mcmd host to the test server again. Test if the output works by uploading it to the test server:

```commandline
mcmd run vkgl_cleanup_consensus
mcmd run vkgl_cleanup_labs
mcmd delete --data vkgl_comments -f
mcmd import vkgl_comments.csv
mcmd run vkgl_import_labs
mcmd import vkgl_consensus_comments.csv
mcmd import vkgl_consensus.csv
mcmd delete --data vkgl_public_consensus -f
mcmd import vkgl_public_consensus.csv
```

If you get a `504` error throughout this process. You can start a mcmd script from a certain line using
the `--from-line` command. Keep retrying until you don't get the `504` anymore. Trust me, it will work.

30. Time to upload production. Set a message on the homepage by editing the `home` row in `sys_StaticContent` (don't do
    it via the home page, it will mess up everything!):

```html

<div class="alert alert-warning" role="alert">
    We are currently working on the new VKGL data release, this means some data might be missing or incorrect. As soon
    as
    this message is no longer on our homepage, the release is updated and save to use. We thank you for your
    understanding
    and patience.
</div>
```

31. Set the mcmd host to production and run the following commands on production:

```commandline
mcmd run vkgl_cleanup_consensus
mcmd run vkgl_cleanup_labs
mcmd delete --data vkgl_comments -f
mcmd import vkgl_comments.csv
mcmd run vkgl_import_labs
mcmd import vkgl_consensus_comments.csv
mcmd import vkgl_consensus.csv
mcmd delete --data vkgl_public_consensus -f
mcmd import vkgl_public_consensus.csv
```

32. Update the counts page by editing the `news` row in the `sys_StaticContent` table and paste the `counts.html` that
    was produced by `molgenis-py-consensus`.

33. Upload the public consensus to the downloadserver and update the downloads page in the static content table.
34. Update the name of the export in the menu.
35. Update the name of the export on the homepage and remove the message.
36. Email the contact persons for acceptance testing.
37. Once accepted, do the clinvar submissions. [Need help?](https://github.com/molgenis/vkgl-clinvar)
38. Send the email notifying everyone that the VKGL release is done and the clinvar submission is in progress.
39. Send the files from the preprocessed folder of `run.sh` and the raw files of radboud/MUMC and LUMC to the LUMC and
    Radboud/MUMC.
40. Send the error files to all labs.
41. Make a `vip` directory in your VKGL release directory.
42. Go to `data-transform-vkgl/dir/data-release-pipeline/utils` and generate the gene id's for the consensus file:

```
./vkgl_consensus_add_gene_id.sh -i /path/to/molgenis/output/vkgl_consensus.tsv -o /path/to/vipdir/molgenis-consensus-output/vkgl_consensus.tsv -g ../datetimeoftransformeddata/downloads/hgnc_genes_20210920.tsv
./vkgl_consensus_add_gene_id.sh -i /path/to/molgenis/output/vkgl_public_consensus.tsv -o /path/to/vipdir/molgenis-consensus-output/vkgl_public_consensus.tsv -g ../datetimeoftransformeddata/downloads/hgnc_genes_20210920.tsv
```

43. Get the vcf-tsv converter in the utils folder of data-transform:

```commandline
wget https://github.com/molgenis/tsv-vcf-converter/releases/download/vx.y.z/tsv-vcf-converter.jar
```

44. Do the liftover for the vip data:

```
./liftover_vkgl_consensus.sh /path/to/vipdir/vkgl_public_consensus.tsv /path/to/vipdir/vkgl_public_consensus_hg38.tsv
./liftover_vkgl_consensus.sh /path/to/vipdir/vkgl_consensus.tsv /path/to/vipdir/vkgl_consensus_hg38.tsv
```

45. Deploy data (with _monyyyy as postfix) of `vip` directory on the clusters:

    **Fender**

    ***Public only**, GRCh37 + GRCh38*
    ```
    /apps/data/VKGL/GRCh37/
    /apps/data/VKGL/GRCh38/
    ```
    **Gearshift**
    
    *public + private + artefacts, GRCh37 + GRCh38*
    ```
    /apps/data/VKGL/GRCh37/
    /apps/data/VKGL/GRCh38/
    ```
    **zf-ds**
    
    *public + private + artefacts, **GRCh37 only***
    ```
    /apps/data/VKGL/GRCh37/
    ```
46. Persist data on the`gearshift` cluster. Create a new folder with a name like `yyyymm` in
    the `/groups/umcg-gcc/prm03/projects/VKGL/` folder.
47. In this directory make the following folders:

- clinvar
- molgenis
- raw
- data-transform
- vip

48. Fill the raw folder by copying all raw data you got from Radboud/MUMC, LUMC and all Alissa data.
49. Fill the data-transform folder by copying all data from the data-transform-vkgl/data-release-pipeline/dateofyourdata
    using cp -r to it
50. In the molgenis folder create an input and an output folder.
51. In the input directory place all content of the input folder of molgenis-py-consensus.
52. In the output directory place all content of the output folder of molgenis-py-consensus.
53. Fill the `vip` folder with all data in the `vip` folder on tmp.
54. Go to the ClinVar folder and make a `generated` and `reports` folder in there.
55. Copy all content of the folder with the output of the vkgl-clinvar-writer to the generated folder.
56. When ClinVar is done evaluating, go to the submission portal and download all reports and place them in the reports
    folder. Prefix them with the correct lab name.
57. Create a `versions.txt` in `/groups/umcg-gcc/prm03/projects/VKGL/yyyymm/` with the following content:
    ```text
    DATA:
    Alissa: yyyymmdd
    Radboud/MUMC: yyyy-mm-dd
    LUMC: yyyy-mm-dd
    HGNC genes file: yyyymmdd

    Scripts:
    data-transform-vkgl and run.sh: data-release-vx.y.z
    tsv-vcf-converter: vx.y.z
    vkgl-clinvar: vx.y.z
    molgenis-py-consensus: x.y.z
    molgenis-tools-emx-downloader: x.y.z
    molgenis-tools-commander: vx.y.z
    ```
    Fill in the versions used for this export.